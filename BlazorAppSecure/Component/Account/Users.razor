@page "/users"

@using BlazorAppSecure.Model
@using BlazorAppSecure.Sevices
@using Microsoft.AspNetCore.Authorization
@using System.ComponentModel
@using System.ComponentModel.DataAnnotations;
@using AntDesign

@attribute [Authorize(Roles = "Admin")]

@inject IAccountManagement Acct
@inject NavigationManager Navigation
@inject IMessageService _mess
@inject IJSRuntime JS

<div class="mb-2">
    <Breadcrumb>
        <BreadcrumbItem Href="">
            <Icon Type="@IconType.Outline.Home" />
        </BreadcrumbItem>
        <BreadcrumbItem>
            Users & Roles Management
        </BreadcrumbItem>
    </Breadcrumb>
</div>

<GridRow Gutter="12">
    <GridCol Span="18">
        <div class="table-control">
            <Button Icon="@IconType.Outline.Download" OnClick="ExportToExcel">Export to Excel</Button>

            <Button Icon="@IconType.Outline.Reload" OnClick="() => HandleReloadListUser()" Loading="loadingUserList"></Button>
        </div>
        <Table DataSource="userList" PageSize="12" ScrollX="1000" ScrollY="400" Loading="loadingUserList" Bordered>
            <PropertyColumn Property="u=>u.Email" Width="200" Fixed="ColumnFixPlacement.Left" />
            <PropertyColumn Property="u=>u.FullName" Width="200" Title="FullName">
                @if (context.FullName != null) {
                    @context.FullName
                } else {
                    <Tag Color="TagColor.Orange">Null</Tag>
                }
            </PropertyColumn>
            <PropertyColumn Property="c=>c.UserName" Width="200" Title="UserName" />
            <PropertyColumn Property="c=>c.Roles" Width="200" Title="Roles">
                <div class="roles-tag">
                    @if (context.Roles != null && context.Roles?.Count > 0) {
                        @foreach (var item in context.Roles) {
                            <Tag Style="margin-right: 0px">@item</Tag>
                        }
                    } else {
                        <Tag Color="TagColor.Orange">Null</Tag>
                    }
                </div>
            </PropertyColumn>
            <PropertyColumn Property="c=>c.EmailConfirmed" Width="150" Title="Email Confirmed">
                <Switch Checked="@context.EmailConfirmed" Disabled />
            </PropertyColumn>
            <PropertyColumn Property="c=>c.PhoneNumber" Width="150" Title="Phone Number">
                @if (context.PhoneNumber != null) {
                    @context.PhoneNumber
                } else {
                    <Tag Color="TagColor.Orange">Null</Tag>
                }
            </PropertyColumn>
            <PropertyColumn Property="c=>c.PhoneNumberConfirmed" Width="230" Title="Phone Number Confirmed">
                <Switch Checked="@context.PhoneNumberConfirmed" Disabled />
            </PropertyColumn>
            <ActionColumn Title="Action" Width="120" Align="ColumnAlign.Center" Fixed="ColumnFixPlacement.Right">
                <CellRender Context="cellData">
                    <Button Type="ButtonType.Text" Icon="@IconType.Outline.Edit" @onclick="@(() => Edit(context))" Class="ant-btn-edit"></Button>
                    <Button Type="ButtonType.Text" Icon="@IconType.Outline.Delete" Class="ant-btn-delete"></Button>
                </CellRender>
            </ActionColumn>
        </Table>
    </GridCol>
    <GridCol Span="6">
        <div class="table-control">
            <Button Icon="@IconType.Outline.Plus" Type="ButtonType.Primary" @onclick="_=>OpenAddRoleDrawer()">Add Role</Button>
            <Button Icon="@IconType.Outline.Reload" OnClick="() => HandleReloadRoles()" Loading="loadingRoleList"></Button>
        </div>
        <Table DataSource="roleList" HidePagination Loading="loadingRoleList" ScrollY="400" Bordered>
            <ColumnDefinitions>
                <PropertyColumn Property="r=>r.Name" Title="Role Name" />
            </ColumnDefinitions>
        </Table>
    </GridCol>
</GridRow>

<Drawer Closable="true" Width="400" Visible="addRoleVisiable" Title='("Add new role")' OnClose="_=>CloseAddRoleDrawer()">
    <Template style="height:90%">
        <Form Model="@addNewRoleModel" OnFinish="SubmitNewRole">
            <Row Gutter="16">
                <AntDesign.Col Span="24">
                    <Text>Role name</Text>
                    <FormItem>
                        <Input Placeholder="Please enter role name" TValue="string" @bind-Value="@context.RoleName"></Input>
                    </FormItem>
                </AntDesign.Col>
            </Row>
            <Row Class="mt-3">
                <AntDesign.Col Span="24" Class="d-flex justify-content-end gap-2">
                    <Button Type="ButtonType.Default" @onclick="CloseAddRoleDrawer">Cancel</Button>
                    <Button Type="ButtonType.Primary" HtmlType="HtmlType.Submit">Submit</Button>
                </AntDesign.Col>
            </Row>
        </Form>
    </Template>
</Drawer>

@code {
    private IQueryable<UserViewModel> userList;
    private List<Role> roleList;

    private bool loadingUserList = false;
    private bool loadingRoleList = false;
    bool addRoleVisiable = false;

    private AddNewRoleModel addNewRoleModel = new();

    void OpenAddRoleDrawer()
    {
        addNewRoleModel = new();
        this.addRoleVisiable = true;
    }

    void CloseAddRoleDrawer() {
        this.addRoleVisiable = false;
    }

    protected override async Task OnInitializedAsync()
    {
        loadingUserList = true;
        loadingRoleList = true;
        var usersRes = await Acct.GetUsers();
        var rolesRes = await Acct.GetRoles();
        userList = usersRes.ToList().AsQueryable();
        roleList = rolesRes.ToList();
        await base.OnInitializedAsync();
        loadingUserList = false;
        loadingRoleList = false;
    }

    void Edit(UserViewModel p)
    {
        Navigation.NavigateTo($"editupdateuser/{p.Email}");        
    }

    async void Delete(UserViewModel p)
    {
        if(await Acct.Delete(p.Email))
        {
            var users = await Acct.GetUsers();
            userList = users.ToList().AsQueryable();
            StateHasChanged();
        }
    }

    async void HandleReloadListUser() {
        loadingUserList = true;
        var usersRes = await Acct.GetUsers();
        userList = usersRes.ToList().AsQueryable();
        loadingUserList = false;
        StateHasChanged();
    }

    async void HandleReloadRoles() {
        loadingRoleList = true;
        var rolesRes = await Acct.GetRoles();
        roleList = rolesRes.ToList();
        loadingRoleList = false;
        StateHasChanged();
    }

    async void SubmitNewRole() {
        var response = await Acct.AddRole(addNewRoleModel.RoleName);

        if (response.Succeeded) {
            addRoleVisiable = false;
            StateHasChanged();
            HandleReloadRoles();
            await _mess.Success("Add new role success");
        } else {
            response.ErrorList.ForEach((err) =>
            {
                _mess.Error(err);
            });
        }
    }

    async void ExportToExcel()
    {
        using var package = new OfficeOpenXml.ExcelPackage();
        var worksheet = package.Workbook.Worksheets.Add("Users");

        // Header Row Styling
        using (var headerRange = worksheet.Cells["A1:G1"])
        {
            headerRange.Style.Font.Bold = true;
            headerRange.Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
            headerRange.Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightBlue);
            headerRange.Style.HorizontalAlignment = OfficeOpenXml.Style.ExcelHorizontalAlignment.Center;
            headerRange.Style.VerticalAlignment = OfficeOpenXml.Style.ExcelVerticalAlignment.Center;
            headerRange.Style.Border.BorderAround(OfficeOpenXml.Style.ExcelBorderStyle.Medium);
        }

        // Thêm tiêu đề cột
        worksheet.Cells[1, 1].Value = "Email";
        worksheet.Cells[1, 2].Value = "Full Name";
        worksheet.Cells[1, 3].Value = "User Name";
        worksheet.Cells[1, 4].Value = "Roles";
        worksheet.Cells[1, 5].Value = "Email Confirmed";
        worksheet.Cells[1, 6].Value = "Phone Number";
        worksheet.Cells[1, 7].Value = "Phone Confirmed";

        // Thêm dữ liệu từ danh sách userList
        int row = 2;
        foreach (var user in userList)
        {
            worksheet.Cells[row, 1].Value = user.Email;
            worksheet.Cells[row, 2].Value = user.FullName ?? "N/A";
            worksheet.Cells[row, 3].Value = user.UserName;
            worksheet.Cells[row, 4].Value = user.Roles != null ? string.Join(", ", user.Roles) : "N/A";
            worksheet.Cells[row, 5].Value = user.EmailConfirmed ? "Yes" : "No";
            worksheet.Cells[row, 6].Value = user.PhoneNumber ?? "N/A";
            worksheet.Cells[row, 7].Value = user.PhoneNumberConfirmed ? "Yes" : "No";

            // Alternating row colors for readability
            if (row % 2 == 0)
            {
                using (var rowRange = worksheet.Cells[$"A{row}:G{row}"])
                {
                    rowRange.Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
                    rowRange.Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);
                }
            }

            // Add borders to each cell
            using (var cellRange = worksheet.Cells[$"A{row}:G{row}"])
            {
                cellRange.Style.Border.BorderAround(OfficeOpenXml.Style.ExcelBorderStyle.Thin);
            }

            row++;
        }

        // AutoFit Columns
        worksheet.Cells.AutoFitColumns();

        // Xuất file
        var fileContent = package.GetAsByteArray();
        var fileName = "UsersList.xlsx";
        if (fileContent == null || fileContent.Length == 0)
        {
            await _mess.Error("File generation failed!");
            return;
        }

        var base64 = Convert.ToBase64String(fileContent);

        // Convert byte[] thành Base64 để tải về
        await JS.InvokeVoidAsync("saveAsFile", fileName, base64);
    }

    

    public class AddNewRoleModel {
        [Required(ErrorMessage = "Role name is required")]
        public string RoleName { get; set; }
    }
}

<style>
    .roles-tag {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .table-control {
        display: flex;
        gap: 0.5rem;
        justify-content: end;
        margin-bottom: 10px;
    }
</style>
